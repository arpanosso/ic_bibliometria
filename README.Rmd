---
output: github_document
---


<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  # eval = FALSE,
  comment = "#>"
)
```


## TCC - Maria Eduarda - Bibliometria

### Carregando Pacotes

```{r}
library(tidyverse)
```

###  Carregando a Base
```{r}
base_wos <- readxl::read_xlsx("data_raw/wob_extraidos.xlsx") |> 
  janitor::clean_names() |> 
  mutate(
    abstract_1 = str_remove_all(abstract_1, "\r"),
    abstract_2 = str_remove_all(abstract_2, "\r"),
    research_areas   = str_replace_all(research_areas, "\n", " "),
    research_areas   = str_replace_all(research_areas, "  ", " "),
    titulo = str_remove_all(titulo, "\r|™"),
    autor = str_to_title(autor),
    nome_base = "wos"
  ) |> 
  rename( resumo = abstract_1)
base_me <- readxl::read_xlsx("data_raw/Arquivos Extraídos/search_result--1968698800-csv/search_result--1968698800-csv.xlsx") |> janitor::clean_names() |> 
  rename(autor = autor_a,ano = ano_de_defesa,
         instituicao = instituicao_de_defesa,
         pais = pais_da_instituicao_de_defesa) |> 
  mutate(pais = ifelse(pais == "Não informado pela instituição","Brasil",pais),
         assuntos_em_portugues = str_remove_all(assuntos_em_portugues,"\\|"),
         assuntos_em_ingles = str_remove_all(assuntos_em_portugues,"\\|"),
         autor = str_to_title(autor),
         nome_base = "bdtd")
```

```{r}
glimpse(base_me) 
```

## Juntando  e tratando as Bases

```{r}
base_completa <- rbind(base_wos |> 
  select(nome_base, autor, ano, titulo, instituicao, resumo, pais),
base_me |> 
  select(nome_base, autor, ano, titulo, instituicao, resumo, pais)
) |> 
  distinct() |> 
  mutate(
    pais = str_replace(pais, "BR|Brasil|brasil|brazil","Brazil"),
    ano = as.numeric(ano)
  )
```

### Estatística Descritiva



#### Número de Documentos por Ano / País
```{r}
base_completa |> 
  group_by(ano,pais,nome_base) |> 
  count() |> 
  ggplot(aes(ano, n, fill=pais)) +
  geom_col(color="black") +
  labs(x="Ano", y = "Número de Documentos") +
  theme_minimal() +
  facet_wrap(~nome_base)
```

#### Soma do número de documentos para o período todo (2020 a 2025)

```{r}
base_completa |> 
  group_by(pais,nome_base) |> 
  count() |> 
  ungroup() |> 
  mutate(pais = fct_reorder(pais,n)) |> 
  ggplot(aes(y=pais, x=n)) +
  geom_col(color="black",fill="aquamarine4") +
  labs(x="Soma dos Documentos", y = "País") +
  theme_minimal() +
  facet_wrap(~nome_base)
```


##### Exemplo
```{r}
base_completa |> 
  mutate(
    ia_count = as.numeric(str_detect(
      str_to_lower(resumo), 
      "(artificial\\s+inteligente|\\bai\\b|environmental impact)"))
  ) |> group_by(ano) |> 
  summarise(
    n = sum(ia_count),
    .groups = "drop"
  ) |> 
  ggplot(aes(x=ano, y=n)) + 
  geom_point() +
  geom_line() +
  theme_bw()
```



## Número de artigos por ano

```{r}
base_completa |> 
  group_by(ano) |> 
  count() |> 
  ggplot(aes(ano, n)) +
  geom_col(color="black", fill="gray") +
  labs(x="Ano", y = "Número de Documentos") +
  theme_minimal()
```
```{r}
base_completa |> 
  group_by(ano) |> 
  count()
```


## Crescimento da produção científica

```{r}
df_plot <- base_completa %>%
  count(ano, name = "n") %>%
  complete(ano = full_seq(ano, 1), fill = list(n = 0)) %>%
  mutate(
    crescimento_pct = (n / lag(n) - 1) * 100,
    # tratar casos problemáticos: divisão por 0 ou Inf/NaN
    crescimento_pct = if_else(is.infinite(crescimento_pct) | is.nan(crescimento_pct), NA_real_, crescimento_pct),
    crescimento_pct = round(crescimento_pct, 2)
  ) 

df_plot |> 
  ggplot(aes(x = ano, y = crescimento_pct)) +
  geom_line() +
  geom_point() +
  geom_text(
    data = df_plot |> filter(!is.na(crescimento_pct)),
    aes(label = paste0(crescimento_pct, "%")),
    vjust = -0.5, size = 3
  ) +
  labs(x = "Ano", y = "Crescimento (%)") +
  theme_minimal()
```


```{r}
base_completa %>%
  count(ano, name = "n") %>%
  complete(ano = full_seq(ano, 1), fill = list(n = 0)) %>%
  mutate(
    crescimento_pct = (n / lag(n) - 1) * 100,
    # tratar casos problemáticos: divisão por 0 ou Inf/NaN
    crescimento_pct = if_else(is.infinite(crescimento_pct) | is.nan(crescimento_pct), NA_real_, crescimento_pct),
    crescimento_pct = round(crescimento_pct, 2)
  )
```

## Instituições mais produtivas

```{r}
base_completa %>%
  filter(pais == "Brazil") %>%
  count(instituicao, name = "n") %>%
  arrange(desc(n)) %>% 
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(instituicao, n), y = n)) +
  geom_col(fill = "gray", color = "black") +
  coord_flip() +
  labs(x = "Instituição - Nacional", y = "Número de Documentos") +
  theme_minimal()
```

```{r}
base_completa %>%
  filter(pais != "Brazil") %>%
  count(instituicao, name = "n") %>%
  arrange(desc(n)) %>% 
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(instituicao, n), y = n)) +
  geom_col(fill = "orange", color = "black") +
  coord_flip() +
  labs(x = "Instituição - Internacional", y = "Número de Documentos") +
  theme_minimal()
```



## Dimensão geográfica da produção científica 

```{r}

base_completa %>%
  filter(pais != "Brazil")  %>%
  count(pais, name = "n") %>%
  arrange(desc(n)) %>%
  slice_head(n = 10) %>%
  ggplot(aes(x = reorder(pais, n), y = n)) +
  geom_col(fill = "gray", color = "black") +
  coord_flip() +
  labs(x = "País", y = "Número de Documentos") +
  theme_minimal()
```

```{r}
library(sf)
library(rnaturalearth)


# contagem por país
pais_prod <- base_completa %>%
  filter(nome_base == "wos") %>%
  count(pais, name = "n")

# mapa mundo
world <- ne_countries(scale = "medium", returnclass = "sf")

# unir seus dados ao mapa
mapa <- world %>%
  left_join(pais_prod, by = c("admin" = "pais"))

# plot
ggplot(mapa) +
  geom_sf(aes(fill = n), color = "gray40", size = 0.1) +
  scale_fill_gradient(
    name = "Documentos",
    low = "blue", high = "red",
    na.value = "white"
  ) +
  labs(x = NULL, y = NULL) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text = element_blank(),
    panel.grid = element_blank()
  )


```

## Palavras-chave dominantes

```{r}
library(tidytext)
palavras <- base_completa %>%
  filter(pais != "Brazil") %>% 
  select(resumo) %>%
  unnest_tokens(word, resumo) %>%        # quebra em palavras
  filter(!word %in% stop_words$word) %>% # remove stopwords em inglês
  filter(str_detect(word, "^[a-z]+$")) %>%  # limpa lixo
  count(word, sort = TRUE)
palavras %>% slice_max(n, n = 20)
palavras %>%
  slice_max(n, n = 20) %>%
  ggplot(aes(x = reorder(word, n), y = n)) +
  geom_col(fill = "gray", color = "black") +
  coord_flip() +
  labs(x = "Palavra", y = "Frequência") +
  theme_minimal()
```
```{r}
bigrams <- base_completa %>%
  filter(pais != "Brazil") %>% 
  select(resumo) %>%
  unnest_tokens(bigram, resumo, token = "ngrams", n = 2) %>%
  separate(bigram, c("w1", "w2"), sep = " ") %>%
  filter(!w1 %in% stop_words$word,
         !w2 %in% stop_words$word) %>%
  unite(bigram, w1, w2, sep = " ") %>%
  count(bigram, sort = TRUE)
bigrams %>% slice_max(n, n = 20)
```


## Principais áreas de pesquisa 

```{r}
areas <- base_completa %>%
  filter(pais != "Brazil") %>% 
  select(resumo) %>%
  unnest_tokens(word, resumo) %>%
  filter(!word %in% stop_words$word) %>%       # remove stopwords
  filter(str_detect(word, "^[a-z]+$")) %>%     # limpa lixo
  count(word, sort = TRUE)
areas %>% slice_max(n, n = 30)
bigrams <- base_completa %>%
  filter(pais != "Brazil") %>% 
  select(resumo) %>%
  unnest_tokens(bigram, resumo, token = "ngrams", n = 2) %>%
  separate(bigram, c("w1","w2"), sep = " ") %>%
  filter(!w1 %in% stop_words$word,
         !w2 %in% stop_words$word) %>%
  unite(bigram, w1, w2, sep = " ") %>%
  count(bigram, sort = TRUE)
bigrams %>% slice_max(n, n = 30)
```


#### 1

```{r}
# library(quanteda)
# library(quanteda.textstats)
# library(igraph)
# 
# vetor_de_resumos <- base_completa |> 
#   slice(1:10) |> 
#   pull(resumo)
# corp <- corpus(vetor_de_resumos)
# toks <- tokens(corp, remove_punct = TRUE, remove_numbers = TRUE)
# toks <- tokens_remove(toks, stopwords("en"))
# 
# fcmat <- fcm(toks, context = "window", tri = FALSE)
# g <- graph_from_adjacency_matrix(fcmat, weighted = TRUE, mode = "undirected")
# plot(g)
```



